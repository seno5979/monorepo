# CI/CD for tvc-service
# Auto-generated by IDP Golden Path - Uses shared reusable workflows
# Team: publisher-team
name: tvc-service

on:
  pull_request:
    paths:
      - 'services/tvc-service/**'
      - '.github/workflows/tvc-service-ci.yml'
  push:
    branches: [main]
    paths:
      - 'services/tvc-service/**'
      - '.github/workflows/tvc-service-ci.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  build-test:
    uses: ./.github/workflows/shared-build-test.yml
    with:
      service_name: tvc-service
      service_path: services/tvc-service
      runtime: KOTLIN_GRADLE
      use_sonarqube: true
      use_snyk: true
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  docker-build:
    needs: build-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/shared-docker-build.yml
    with:
      service_name: tvc-service
      service_path: services/tvc-service
      team_name: publisher-team
    secrets:
      AWS_ECR_ROLE_ARN: ${{ secrets.AWS_ECR_ROLE_ARN }}

  deploy-dev:
    needs: docker-build
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/shared-helm-deploy.yml
    with:
      service_name: tvc-service
      service_path: services/tvc-service
      team_name: publisher-team
      environment: dev
      image_tag: ${{ github.sha }}
    secrets:
      AWS_DEPLOY_ROLE_ARN: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}

  deploy-uat:
    needs: deploy-dev
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/shared-helm-deploy.yml
    with:
      service_name: tvc-service
      service_path: services/tvc-service
      team_name: publisher-team
      environment: uat
      image_tag: ${{ github.sha }}
    secrets:
      AWS_DEPLOY_ROLE_ARN: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}

  deploy-prod:
    needs: deploy-uat
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/shared-helm-deploy.yml
    with:
      service_name: tvc-service
      service_path: services/tvc-service
      team_name: publisher-team
      environment: prod
      image_tag: ${{ github.sha }}
    secrets:
      AWS_DEPLOY_ROLE_ARN: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
